<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARAUCO|Upgrade Sistema de Control DCS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Aplicación del color de fuente personalizado a todo el documento */
        body { 
            font-family: 'Inter', sans-serif; 
            color: #696158;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
            border: 2px solid #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }
        .hero-section {
            height: 30vh;
            background-image: url('https://i.postimg.cc/5y5CHdnr/ARAUCO-01-1.png');
            background-repeat: no-repeat;
            background-size: 50vh;
            background-position: center;
            position: relative;
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para la fase activa */
        .active-phase-card {
            border-color: #EA7600 !important;
            background-color: rgba(234, 118, 0, 0.04) !important;
        }
        .active-phase-icon-bg {
            background-color: rgba(234, 118, 0, 0.1) !important;
            color: #EA7600 !important;
        }

        /* Forzamos el color de texto en elementos específicos */
        .text-arauco-base { color: #696158 !important; }
        .text-arauco-orange { color: #EA7600 !important; }
        
        /* Estilo personalizado para el contenedor de Avance Total */
        .bg-arauco-total {
            background-color: #696158 !important;
        }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen">
    <section class="hero-section flex items-end justify-end" id="heroSection">
        <h1 class="text-2xl font-extrabold text-white text-shadow-lg p-4 bg-black bg-opacity-60 rounded-lg">
            Upgrade Sistema de Control DCS
        </h1>
    </section>

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Estado de Carga -->
        <div id="loading" class="fixed inset-0 bg-slate-50 flex flex-col items-center justify-center z-50">
            <div class="w-12 h-12 border-4 border-[#EA7600] border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-bold text-[#696158] uppercase tracking-widest text-[10px]">Cargando cronograma...</p>
        </div>

        <!-- Encabezado -->
        <div class="bg-white rounded-[0.8rem] shadow-sm p-8 mb-8 border border-slate-200/60 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 rounded-full bg-[#EA7600]"></div>
                    <span class="text-[10px] font-black text-[#EA7600] uppercase tracking-widest">Estado General de Upgrade</span>
                </div>
                <h1 class="text-3xl font-black tracking-tighter uppercase text-[#696158]">Upgrade DeltaV 15.LTS</h1>
                <p class="text-[#696158] text-sm font-semibold">ARAUCO Planta Constitución • Control Dinámico</p>
            </div>
            
            <div class="flex gap-4 items-center">
                <button onclick="exportToExcel()" class="flex items-center gap-2 bg-white border-2 border-slate-100 hover:border-[#EA7600] hover:text-[#EA7600] px-6 py-3 rounded-2xl text-xs font-black uppercase transition-all shadow-sm text-[#696158]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Exportar Reporte
                </button>
                <div class="bg-arauco-total px-8 py-5 rounded-[0.8rem] shadow-xl shadow-slate-200 text-center">
                    <p class="text-[9px] font-bold text-white uppercase mb-1 tracking-widest">Avance Total</p>
                    <p id="global-progress-text" class="text-4xl font-black text-white">0%</p>
                </div>
            </div>
        </div>

        <!-- Navegación de Fases -->
        <div id="phases-nav" class="flex overflow-x-auto gap-4 pb-6 mb-4 px-2 pt-4 custom-scrollbar">
            <!-- Se llena dinámicamente -->
        </div>

        <!-- Contenido de Fase Activa -->
        <div id="active-phase-content" class="grid lg:grid-cols-12 gap-8 animate-fade-in hidden">
            <!-- Panel Lateral -->
            <div class="lg:col-span-3 space-y-6">
                <div class="bg-white rounded-[0.8rem] p-6 shadow-sm border border-slate-200/60">
                    <h2 class="text-[10px] font-black text-[#EA7600] uppercase tracking-widest mb-6 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12" y1="8" y2="8"/></svg>
                        Detalles Etapa: <span id="sidebar-phase-id"></span>
                    </h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="text-[9px] font-black text-[#696158] uppercase block mb-2">Líder / Responsable</label>
                            <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[#EA7600]"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <span id="sidebar-owner" class="text-xs font-black text-[#696158] uppercase tracking-tight"></span>
                            </div>
                        </div>

                        <div>
                            <label class="text-[9px] font-black text-[#696158] uppercase block mb-2">Estatus</label>
                            <div id="sidebar-status-pill" class="text-center py-2 rounded-lg text-[10px] font-black uppercase tracking-widest">
                                <!-- Texto de estatus -->
                            </div>
                        </div>

                        <div class="pt-4 border-t border-slate-100 flex flex-col items-center">
                            <p class="text-[9px] font-black text-[#696158] uppercase mb-2">Avance Etapa</p>
                            <div id="sidebar-progress-text" class="text-4xl font-black text-[#696158] tracking-tighter">0%</div>
                            <div class="w-full h-2 bg-slate-100 rounded-full mt-2 overflow-hidden">
                                <div id="sidebar-progress-bar" class="h-full transition-all duration-500"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Tareas -->
            <div class="lg:col-span-9">
                <div class="bg-white rounded-[0.8rem] shadow-sm border border-slate-200/60 overflow-hidden">
                    <div class="p-8 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                        <h3 id="phase-title" class="text-sm font-black text-[#696158] uppercase tracking-tight"></h3>
                        <div class="flex gap-2">
                            <span id="task-count" class="text-[10px] font-black bg-[#696158] px-3 py-1 rounded-full text-white uppercase tracking-widest">
                                0 Tareas vinculadas
                            </span>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-[10px] font-black text-[#696158] uppercase tracking-widest border-b border-slate-100 bg-slate-50/50">
                                    <th class="px-8 py-4 text-left">Descripción</th>
                                    <th class="px-4 py-4 text-left">Responsable</th>
                                    <th class="px-4 py-4 text-left">Programación</th>
                                    <th class="px-4 py-4 text-center">Avance</th>
                                    <th class="px-8 py-4 text-right">Estatus</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-body" class="divide-y divide-slate-100">
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1_fbeGKbnikm_fn-atSFgKMO7x5pSZTue';
        const EXCEL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=xlsx`;
        
        let projectData = [];
        let globalProgress = 0;
        let activePhaseId = null;

        const CORPORATE_COLOR = "#EA7600";
        const SUCCESS_COLOR = "#BFB800";
        const TEXT_COLOR = "#696158";

        function formatExcelDate(value) {
            if (!value) return "Por definir";
            if (typeof value === 'string' && value.includes('/')) return value.trim();
            if (!isNaN(value) && typeof value === 'number') {
                const date = new Date((value - 25569) * 86400 * 1000);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            return String(value).trim();
        }

        async function fetchData() {
            try {
                const response = await fetch(EXCEL_URL);
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

                if (rows.length < 2) return;

                const allTasks = rows.slice(1)
                    .filter(cols => cols[0] !== undefined && String(cols[0]).trim() !== "")
                    .map(cols => {
                        let idStr = String(cols[0]).trim().replace(/,/g, '.');
                        let rawProgress = cols[5];
                        let progressNum = 0;
                        if (rawProgress) {
                            let cleanProgress = String(rawProgress).replace('%', '').trim();
                            progressNum = parseFloat(cleanProgress) || 0;
                            if (progressNum > 0 && progressNum <= 1 && String(rawProgress).includes('0.')) {
                                progressNum = progressNum * 100;
                            }
                        }

                        return {
                            id: idStr,
                            name: String(cols[1] || "Actividad sin nombre").trim(),
                            start: formatExcelDate(cols[2]),
                            end: formatExcelDate(cols[3]),
                            taskProgress: Math.min(100, Math.max(0, Math.round(progressNum))),
                            resp: String(cols[6] || "Equipo General").trim(),
                            isSubTask: idStr.includes('.')
                        };
                    });

                const taskZero = allTasks.find(t => t.id === "0");
                globalProgress = taskZero ? taskZero.taskProgress : 0;
                document.getElementById('global-progress-text').innerText = `${globalProgress}%`;

                const phasesMap = {};
                allTasks.forEach(task => {
                    if (task.id === "0") return;
                    if (!task.isSubTask) {
                        phasesMap[task.id] = {
                            id: task.id,
                            title: task.name,
                            tasks: [],
                            mainResp: task.resp,
                            phaseProgress: task.taskProgress
                        };
                    }
                });

                allTasks.forEach(task => {
                    if (task.id === "0") return;
                    const parentId = task.id.split('.')[0];
                    if (phasesMap[parentId]) {
                        phasesMap[parentId].tasks.push(task);
                    }
                });

                projectData = Object.keys(phasesMap).map(pId => {
                    const phaseData = phasesMap[pId];
                    return {
                        id: pId,
                        title: phaseData.title,
                        progress: phaseData.phaseProgress,
                        owner: phaseData.mainResp,
                        tasks: phaseData.tasks.sort((a, b) => {
                            const partsA = a.id.split('.').map(Number);
                            const partsB = b.id.split('.').map(Number);
                            for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
                                if (partsA[i] !== partsB[i]) return (partsA[i] || 0) - (partsB[i] || 0);
                            }
                            return 0;
                        })
                    };
                }).sort((a, b) => parseFloat(a.id) - parseFloat(b.id));

                renderPhases();
                if (!activePhaseId && projectData.length > 0) {
                    setActivePhase(projectData[0].id);
                }
                
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error("Error cargando datos:", error);
            }
        }

        function renderPhases() {
            const nav = document.getElementById('phases-nav');
            nav.innerHTML = '';
            
            projectData.forEach(phase => {
                const isActive = activePhaseId === phase.id;
                
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 w-72 p-6 rounded-xl transition-all duration-300 border-2 text-left shadow-sm bg-white mb-2 ${isActive ? 'active-phase-card scale-[1.02]' : 'border-transparent hover:border-slate-200'}`;
                btn.onclick = () => setActivePhase(phase.id);
                
                btn.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="p-2 rounded-xl ${isActive ? 'active-phase-icon-bg' : 'bg-slate-50 text-[#696158]'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        </div>
                        <span class="text-[9px] font-black bg-slate-100 px-2 py-1 rounded-md uppercase text-[#696158]">Etapa ${phase.id}</span>
                    </div>
                    <h3 class="font-black text-[#696158] text-xs uppercase mb-3 line-clamp-2 h-8 leading-tight">${phase.title}</h3>
                    <div class="flex items-center justify-between">
                        <div class="h-1.5 flex-1 bg-slate-100 rounded-full overflow-hidden mr-3">
                            <div class="h-full" style="width: ${phase.progress}%; background-color: ${phase.progress === 100 ? SUCCESS_COLOR : CORPORATE_COLOR}"></div>
                        </div>
                        <span class="text-xs font-black text-[#696158]">${phase.progress}%</span>
                    </div>
                `;
                nav.appendChild(btn);
            });
        }

        function setActivePhase(id) {
            activePhaseId = id;
            const phase = projectData.find(p => p.id === id);
            if (!phase) return;

            document.getElementById('active-phase-content').classList.remove('hidden');
            document.getElementById('sidebar-phase-id').innerText = phase.id;
            document.getElementById('sidebar-owner').innerText = phase.owner;
            document.getElementById('sidebar-progress-text').innerText = `${phase.progress}%`;
            document.getElementById('phase-title').innerText = phase.title;
            document.getElementById('task-count').innerText = `${phase.tasks.length} Tareas vinculadas`;

            const sidebarBar = document.getElementById('sidebar-progress-bar');
            sidebarBar.style.width = `${phase.progress}%`;
            sidebarBar.style.backgroundColor = phase.progress === 100 ? SUCCESS_COLOR : CORPORATE_COLOR;

            const statusPill = document.getElementById('sidebar-status-pill');
            if (phase.progress === 100) {
                statusPill.style.backgroundColor = SUCCESS_COLOR;
                statusPill.style.color = '#FFFFFF';
                statusPill.innerText = "Finalizado";
            } else if (phase.progress > 0) {
                statusPill.style.backgroundColor = CORPORATE_COLOR;
                statusPill.style.color = '#FFFFFF';
                statusPill.innerText = "En Desarrollo";
            } else {
                statusPill.style.backgroundColor = '#696158';
                statusPill.style.color = '#FFFFFF';
                statusPill.innerText = "Pendiente";
            }

            const tbody = document.getElementById('tasks-body');
            tbody.innerHTML = '';
            
            phase.tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.className = `hover:bg-slate-50/50 transition-colors ${task.isSubTask ? 'bg-slate-50/5' : 'font-bold bg-white'}`;
                
                const idBgColor = task.taskProgress === 100 ? SUCCESS_COLOR : (task.taskProgress > 0 ? CORPORATE_COLOR : '#696158');

                tr.innerHTML = `
                    <td class="px-8 py-5">
                        <div class="flex items-start gap-3">
                            <span class="text-[8px] font-black px-1.5 py-0.5 rounded text-white transition-colors duration-500" style="background-color: ${idBgColor}">
                                ${task.id}
                            </span>
                            <span class="text-[#696158] uppercase leading-tight ${task.isSubTask ? 'text-[11px] pl-4 italic font-bold' : 'text-xs'}">
                                ${task.name}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-5">
                        <span class="text-[10px] font-bold text-[#696158] uppercase whitespace-nowrap">${task.resp}</span>
                    </td>
                    <td class="px-4 py-5 whitespace-nowrap text-[9px] font-bold text-[#696158]">
                        <div class="flex flex-col">
                            <span class="font-mono text-[#EA7600]">${task.start}</span>
                            <span class="font-mono text-[#696158]">${task.end}</span>
                        </div>
                    </td>
                    <td class="px-4 py-5">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-black text-[#696158] w-8">${task.taskProgress}%</span>
                            <div class="w-16 h-1 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full transition-all duration-500" style="width: ${task.taskProgress}%; background-color: ${task.taskProgress === 100 ? SUCCESS_COLOR : CORPORATE_COLOR}"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-5 text-right">
                        <span class="px-2 py-1 rounded text-[8px] font-black uppercase text-white transition-colors duration-500" style="background-color: ${
                            task.taskProgress === 100 ? SUCCESS_COLOR : (task.taskProgress > 0 ? CORPORATE_COLOR : '#696158')
                        }">
                            ${task.taskProgress === 100 ? 'Completado' : task.taskProgress > 0 ? 'En Curso' : 'Pendiente'}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            renderPhases(); 
        }

        function exportToExcel() {
            if (!projectData || projectData.length === 0) return;
            const dataToExport = [];
            projectData.forEach(phase => {
                phase.tasks.forEach(task => {
                    dataToExport.push({
                        'ID': task.id,
                        'Actividad': task.name,
                        'Responsable': task.resp,
                        'Fecha Inicio': task.start,
                        'Fecha Término': task.end,
                        'Avance (%)': `${task.taskProgress}%`,
                        'Status': task.taskProgress === 100 ? 'Finalizado' : (task.taskProgress > 0 ? 'En Desarrollo' : 'Pendiente')
                    });
                });
            });
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Cronograma Hitos");
            XLSX.writeFile(wb, `Cronograma_Hitos_Arauco_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        fetchData();
        setInterval(fetchData, 60000); 
    </script>
</body>

</html>
